<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Medication Abbreviator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        h1 {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 28px;
            text-shadow: 0 2px 4px rgba(79, 195, 247, 0.3);
        }
        
        .subtitle {
            color: #9e9e9e;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        textarea {
            width: 100%;
            min-height: 250px;
            padding: 12px;
            background: #252525;
            border: 1px solid #404040;
            border-radius: 8px;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #4fc3f7;
        }
        
        textarea::placeholder {
            color: #666;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(79, 195, 247, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.5);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
        button.secondary:hover {
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.5);
        }
        
        button.tertiary {
            background: linear-gradient(135deg, #ab47bc 0%, #9c27b0 100%);
            box-shadow: 0 2px 8px rgba(156, 39, 176, 0.3);
        }
        
        button.tertiary:hover {
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.5);
        }
        
        .output {
            margin-top: 30px;
        }
        
        .table-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .table-toggle button {
            flex: 1;
            background: #2a2a2a;
            box-shadow: none;
        }
        
        .table-toggle button.active {
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
        }
        
        h2 {
            color: #4fc3f7;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            background: #252525;
            border-radius: 8px;
            overflow: hidden;
        }
        
        th {
            background: linear-gradient(135deg, #2d5a7b 0%, #1e3a5f 100%);
            color: #4fc3f7;
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            border-bottom: 2px solid #4fc3f7;
        }
        
        td {
            padding: 6px 10px;
            border-bottom: 1px solid #333;
            vertical-align: top;
            line-height: 1.6;
        }
        
        tr:hover {
            background: #2a2a2a;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .category-header {
            background: #1e1e1e;
            font-weight: 600;
            color: #29b6f6;
            font-size: 11px;
            width: 140px;
        }
        
        .prn {
            color: #ff6b6b;
            font-weight: 500;
        }
        
        .infusion {
            color: #ffa726;
            font-weight: 500;
        }
        
        .empty-cell {
            color: #555;
            font-style: italic;
        }
        
        .admin-section {
            margin-top: 30px;
            padding: 20px;
            background: #1e1e1e;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .admin-section h3 {
            color: #ab47bc;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .category-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #252525;
            border-radius: 6px;
            border-left: 4px solid #4fc3f7;
        }
        
        .category-section h4 {
            color: #4fc3f7;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .add-med-form {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            margin-top: 10px;
        }
        
        .add-med-form input {
            padding: 8px;
            background: #1e1e1e;
            border: 1px solid #404040;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 12px;
        }
        
        .add-med-form input:focus {
            outline: none;
            border-color: #ab47bc;
        }
        
        .add-med-form button {
            padding: 8px 15px;
            font-size: 12px;
        }
        
        .placeholder {
            color: #888;
            font-style: italic;
            font-size: 11px;
            padding: 5px 0;
        }
        
        .med-database {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 8px;
            font-size: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #252525;
            border-radius: 6px;
        }
        
        .med-database div {
            padding: 4px 8px;
            background: #1e1e1e;
            border-radius: 4px;
            border-left: 3px solid #4fc3f7;
        }
        
        .med-database::-webkit-scrollbar {
            width: 8px;
        }
        
        .med-database::-webkit-scrollbar-track {
            background: #1e1e1e;
            border-radius: 4px;
        }
        
        .med-database::-webkit-scrollbar-thumb {
            background: #4fc3f7;
            border-radius: 4px;
        }
        
        .note {
            background: #2a2a2a;
            border-left: 4px solid #4fc3f7;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 12px;
            color: #b0b0b0;
        }
        
        .note strong {
            color: #4fc3f7;
        }
        
        .table-container {
            margin-bottom: 20px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 12px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: #252525;
            padding: 8px 15px;
            border-radius: 6px;
            border-left: 3px solid #4fc3f7;
        }
        
        .stat-item strong {
            color: #4fc3f7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíä Clinical Medication Abbreviator</h1>
        <p class="subtitle">Advanced medication parsing with dual view (abbreviated & full)</p>
        
        <div class="note">
            <strong>üí° Pro Tip:</strong> Include diet orders (NPO, Regular diet, etc.) anywhere in your input. 
            The system will automatically detect and categorize them.
        </div>
        
        <textarea id="medInput" placeholder="Paste medication list here (including diet orders)..."></textarea>
        
        <div class="button-group">
            <button onclick="processMedications()">üìã Process Medications</button>
            <button class="secondary" onclick="copyTable('abbreviated')">üìÑ Copy Abbreviated</button>
            <button class="secondary" onclick="copyTable('full')">üìÑ Copy Full Table</button>
            <button class="tertiary" onclick="toggleAdmin()">‚öôÔ∏è Manage Database</button>
        </div>
        
        <div id="output" class="output" style="display:none;">
            <div class="table-toggle">
                <button class="active" onclick="switchView('abbreviated')">Abbreviated View</button>
                <button onclick="switchView('full')">Full Medication Names</button>
            </div>
            
            <div id="abbreviatedView" class="table-container"></div>
            <div id="fullView" class="table-container" style="display:none;"></div>
            
            <div class="stats" id="stats"></div>
        </div>
        
        <div id="adminSection" class="admin-section" style="display:none;">
            <h3>üìö Medication Database Management</h3>
            
            <!-- PAIN MEDICATIONS -->
            <div class="category-section">
                <h4>üíâ Pain Medications</h4>
                <div class="add-med-form">
                    <input type="text" id="newMedPain" placeholder="Generic name (e.g., hydromorphone)">
                    <input type="text" id="newAbbrevPain" placeholder="Abbreviation (e.g., D)">
                    <button onclick="addMedToCategory('PAIN', 'newMedPain', 'newAbbrevPain')">‚ûï Add</button>
                </div>
                <div class="placeholder">// Add new pain medications here</div>
            </div>
            
            <!-- ANTIBIOTICS -->
            <div class="category-section">
                <h4>üíä Antibiotics</h4>
                <div class="add-med-form">
                    <input type="text" id="newMedAntibiotics" placeholder="Generic name (e.g., cefepime)">
                    <input type="text" id="newAbbrevAntibiotics" placeholder="Abbreviation (e.g., Cefepime)">
                    <button onclick="addMedToCategory('ANTIBIOTICS', 'newMedAntibiotics', 'newAbbrevAntibiotics')">‚ûï Add</button>
                </div>
                <div class="placeholder">// Add new antibiotics here</div>
            </div>
            
            <!-- PRESSORS/SEDATION -->
            <div class="category-section">
                <h4>üíâ Pressors/Sedation</h4>
                <div class="add-med-form">
                    <input type="text" id="newMedPressors" placeholder="Generic name (e.g., norepinephrine)">
                    <input type="text" id="newAbbrevPressors" placeholder="Abbreviation (e.g., Levo)">
                    <button onclick="addMedToCategory('PRESSORS_SEDATION', 'newMedPressors', 'newAbbrevPressors')">‚ûï Add</button>
                </div>
                <div class="placeholder">// Add new pressors/sedation medications here</div>
            </div>
            
            <!-- ANTICOAGULATION -->
            <div class="category-section">
                <h4>ü©∏ Anticoagulation</h4>
                <div class="add-med-form">
                    <input type="text" id="newMedAnticoag" placeholder="Generic name (e.g., heparin)">
                    <input type="text" id="newAbbrevAnticoag" placeholder="Abbreviation (e.g., Hep)">
                    <button onclick="addMedToCategory('ANTICOAG', 'newMedAnticoag', 'newAbbrevAnticoag')">‚ûï Add</button>
                </div>
                <div class="placeholder">// Add new anticoagulation medications here</div>
            </div>
            
            <!-- NEURO/PSYCH -->
            <div class="category-section">
                <h4>üß† Neuro/Psych</h4>
                <div class="add-med-form">
                    <input type="text" id="newMedNeuro" placeholder="Generic name (e.g., levetiracetam)">
                    <input type="text" id="newAbbrevNeuro" placeholder="Abbreviation (e.g., Keppra)">
                    <button onclick="addMedToCategory('NEURO', 'newMedNeuro', 'newAbbrevNeuro')">‚ûï Add</button>
                </div>
                <div class="placeholder">// Add new neuro/psych medications here</div>
            </div>
            
            <!-- GI MEDICATIONS -->
            <div class="category-section">
                <h4>ü´Å GI Medications</h4>
                <div class="add-med-form">
                    <input type="text" id="newMedGI" placeholder="Generic name (e.g., ondansetron)">
                    <input type="text" id="newAbbrevGI" placeholder="Abbreviation (e.g., Z)">
                    <button onclick="addMedToCategory('GI', 'newMedGI', 'newAbbrevGI')">‚ûï Add</button>
                </div>
                <div class="placeholder">// Add new GI medications here</div>
            </div>
            
            <!-- CARDIO/PULM -->
            <div class="category-section">
                <h4>‚ù§Ô∏è Cardio/Pulm</h4>
                <div class="add-med-form">
                    <input type="text" id="newMedCardio" placeholder="Generic name (e.g., metoprolol)">
                    <input type="text" id="newAbbrevCardio" placeholder="Abbreviation (e.g., Metop)">
                    <button onclick="addMedToCategory('CARDIO_PULM', 'newMedCardio', 'newAbbrevCardio')">‚ûï Add</button>
                </div>
                <div class="placeholder">// Add new cardio/pulm medications here</div>
            </div>
            
            <!-- ENDOCRINE -->
            <div class="category-section">
                <h4>ü©∫ Endocrine</h4>
                <div class="add-med-form">
                    <input type="text" id="newMedEndocrine" placeholder="Generic name (e.g., insulin lispro)">
                    <input type="text" id="newAbbrevEndocrine" placeholder="Abbreviation (e.g., Lispro)">
                    <button onclick="addMedToCategory('ENDOCRINE', 'newMedEndocrine', 'newAbbrevEndocrine')">‚ûï Add</button>
                </div>
                <div class="placeholder">// Add new endocrine medications here</div>
            </div>
            
            <div class="stats" style="margin-top: 20px;">
                <div class="stat-item">
                    <strong>Total Medications:</strong> <span id="medCount">0</span>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <button onclick="showDatabase()">üëÅÔ∏è View All Medications</button>
            </div>
            <div id="medDatabase" class="med-database" style="display:none; margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        // COMPREHENSIVE MEDICATION ABBREVIATION DATABASE
        let MED_ABBREVIATIONS = {
            // Pain medications
            'hydromorphone': 'D',
            'oxycodone': 'O',
            'morphine': 'M',
            'fentanyl': 'F',
            'fentanyl citrate': 'F',
            'acetaminophen': 'T',
            'ibuprofen': 'Ibu',
            'ketorolac': 'Toradol',
            'tramadol': 'Tramadol',
            'hydrocodone': 'Norco',
            'meperidine': 'Demerol',
            'codeine': 'Codeine',
            
            // Antibiotics
            'cefepime': 'Cefepime',
            'vancomycin': 'Vanc',
            'piperacillin-tazobactam': 'Pip-Tazo',
            'piperacillin': 'Pip',
            'tazobactam': 'Tazo',
            'meropenem': 'Mero',
            'imipenem': 'Imi',
            'ceftriaxone': 'CTX',
            'ceftazidime': 'Ceftaz',
            'cefazolin': 'Ancef',
            'azithromycin': 'Azithro',
            'levofloxacin': 'Levo',
            'ciprofloxacin': 'Cipro',
            'metronidazole': 'Flagyl',
            'daptomycin': 'Dapto',
            'eravacycline': 'Xerava',
            'micafungin': 'Mica',
            'caspofungin': 'Caspo',
            'fluconazole': 'Fluc',
            'sulfamethoxazole-trimethoprim': 'TMP-SMX',  // FIXED
            'sulfamethoxazole': 'SMX',
            'trimethoprim': 'TMP',
            'linezolid': 'Zyvox',
            'clindamycin': 'Clinda',
            'ampicillin': 'Amp',
            'gentamicin': 'Gent',
            'tobramycin': 'Tobra',
            
            // Pressors/Sedation
            'norepinephrine': 'Levo',
            'epinephrine': 'Epi',
            'vasopressin': 'Vaso',
            'phenylephrine': 'Neo',
            'dopamine': 'Dopa',
            'dobutamine': 'Dobu',
            'propofol': 'Prop',
            'midazolam': 'Versed',
            'dexmedetomidine': 'Prec',
            'lorazepam': 'Ativan',
            'diazepam': 'Valium',
            'ketamine': 'Ketamine',
            
            // Anticoagulation
            'heparin': 'Hep',
            'enoxaparin': 'Lovenox',
            'warfarin': 'Coumadin',
            'apixaban': 'Eliquis',
            'rivaroxaban': 'Xarelto',
            'dabigatran': 'Pradaxa',
            'aspirin': 'ASA',
            'clopidogrel': 'Plavix',
            'ticagrelor': 'Brilinta',
            'prasugrel': 'Effient',
            
            // Neuro/Psych medications
            'levetiracetam': 'Keppra',
            'phenytoin': 'Dilantin',
            'valproic acid': 'Depakote',
            'carbamazepine': 'Tegretol',
            'lamotrigine': 'Lamictal',
            'topiramate': 'Topamax',
            'gabapentin': 'Neurontin',
            'pregabalin': 'Lyrica',
            'lacosamide': 'Vimpat',
            'haloperidol': 'Haldol',
            'quetiapine': 'Seroquel',
            'olanzapine': 'Zyprexa',
            'risperidone': 'Risperdal',
            'aripiprazole': 'Abilify',
            'ziprasidone': 'Geodon',
            'clozapine': 'Clozaril',
            'lithium': 'Lithium',
            'valproate': 'Depakote',
            'sertraline': 'Zoloft',
            'escitalopram': 'Lexapro',
            'fluoxetine': 'Prozac',
            'paroxetine': 'Paxil',
            'citalopram': 'Celexa',
            'venlafaxine': 'Effexor',
            'duloxetine': 'Cymbalta',
            'bupropion': 'Wellbutrin',
            'mirtazapine': 'Remeron',
            'trazodone': 'Trazodone',
            'clonazepam': 'Klonopin',
            'alprazolam': 'Xanax',
            
            // GI medications
            'ondansetron': 'Z',
            'pantoprazole': 'Protonix',
            'famotidine': 'Pepcid',
            'omeprazole': 'Prilosec',
            'esomeprazole': 'Nexium',
            'lansoprazole': 'Prevacid',
            'ranitidine': 'Zantac',
            'docusate': 'Colace',
            'senna': 'Senna',
            'bisacodyl': 'Dulcolax',
            'polyethylene glycol': 'Miralax',
            'metoclopramide': 'Reglan',
            'promethazine': 'Phenergan',
            'prochlorperazine': 'Compazine',
            
            // Cardio/Pulm (including statins)
            'metoprolol': 'Metop',
            'carvedilol': 'Coreg',
            'atenolol': 'Atenolol',
            'labetalol': 'Labetalol',
            'esmolol': 'Esmolol',
            'lisinopril': 'Lisinopril',
            'enalapril': 'Enalapril',
            'captopril': 'Captopril',
            'losartan': 'Losartan',
            'valsartan': 'Valsartan',
            'amlodipine': 'Norvasc',
            'diltiazem': 'Cardizem',
            'nicardipine': 'Cardene',
            'hydralazine': 'Hydral',
            'furosemide': 'Lasix',
            'bumetanide': 'Bumex',
            'torsemide': 'Torsemide',
            'spironolactone': 'Spiro',
            'albuterol': 'Alb',
            'ipratropium': 'Atro',
            'albuterol-ipratropium': 'DuoNeb',
            'nitroglycerin': 'NTG',
            'isosorbide': 'Imdur',
            'digoxin': 'Dig',
            'amiodarone': 'Amio',
            'sotalol': 'Sotalol',
            'flecainide': 'Flec',
            // STATINS
            'rosuvastatin': 'Crestor',
            'atorvastatin': 'Lipitor',
            'simvastatin': 'Zocor',
            'pravastatin': 'Pravachol',
            'lovastatin': 'Mevacor',
            'fluvastatin': 'Lescol',
            'pitavastatin': 'Livalo',
            
            // Endocrine
            'insulin lispro': 'Lispro',
            'insulin aspart': 'Aspart',
            'insulin regular': 'Reg insulin',
            'insulin isophane': 'NPH',
            'insulin glargine': 'Lantus',
            'insulin detemir': 'Levemir',
            'insulin degludec': 'Tresiba',
            'levothyroxine': 'Synthroid',
            'liothyronine': 'Cytomel',
            'hydrocortisone': 'Solu-Cortef',
            'dexamethasone': 'Decadron',
            
            // Others
            'tacrolimus': 'Tacro',
            'cyclosporine': 'Cyclo',
            'mycophenolate': 'CellCept',
            'prednisone': 'Pred',
            'methylprednisolone': 'Solumedrol',
            'valganciclovir': 'Valcyte',
            'ganciclovir': 'Ganciclovir',
            'acyclovir': 'Acyclovir',
            'valacyclovir': 'Valtrex',
            'entecavir': 'Baraclude',
            'nystatin': 'Nystatin',
            'thiamine': 'Thiamine',
            'folic acid': 'Folate',
            'cholecalciferol': 'Vit D',
            'cyanocobalamin': 'B12',
            'zinc sulfate': 'Zinc',
            'magnesium sulfate': 'Mag',
            'potassium chloride': 'K',
            'calcium gluconate': 'Ca',
            'calcium carbonate': 'CaCO3',
            'erythromycin': 'Erythro',
            'lidocaine': 'Lido',
            'ursodiol': 'Urso',
            'romiplostim': 'Nplate',
            'filgrastim': 'Neupogen',
            'epoetin': 'Epogen',
            'albumin': 'Albumin',
            'immunoglobulin': 'IVIG'
        };

        // Medication categories
        const CATEGORIES = {
            PAIN: ['hydromorphone', 'oxycodone', 'morphine', 'fentanyl', 'acetaminophen', 
                   'ibuprofen', 'ketorolac', 'tramadol', 'hydrocodone', 'meperidine', 'codeine'],
            
            ANTIBIOTICS: ['cefepime', 'vancomycin', 'piperacillin', 'tazobactam', 'meropenem', 'imipenem',
                         'ceftriaxone', 'ceftazidime', 'cefazolin', 'azithromycin', 'levofloxacin', 
                         'ciprofloxacin', 'metronidazole', 'daptomycin', 'eravacycline', 'micafungin',
                         'caspofungin', 'fluconazole', 'sulfamethoxazole', 'trimethoprim', 'linezolid',
                         'clindamycin', 'ampicillin', 'gentamicin', 'tobramycin'],
            
            PRESSORS_SEDATION: ['norepinephrine', 'epinephrine', 'vasopressin', 'phenylephrine', 'dopamine',
                               'dobutamine', 'propofol', 'midazolam', 'dexmedetomidine', 'lorazepam', 
                               'diazepam', 'ketamine'],
            
            ANTICOAG: ['heparin', 'enoxaparin', 'warfarin', 'apixaban', 'rivaroxaban', 'dabigatran',
                      'aspirin', 'clopidogrel', 'ticagrelor', 'prasugrel'],
            
            NEURO: ['levetiracetam', 'phenytoin', 'valproic acid', 'carbamazepine', 'lamotrigine', 
                    'topiramate', 'gabapentin', 'pregabalin', 'lacosamide', 'haloperidol', 'quetiapine',
                    'olanzapine', 'risperidone', 'aripiprazole', 'ziprasidone', 'clozapine', 'lithium',
                    'valproate', 'sertraline', 'escitalopram', 'fluoxetine', 'paroxetine', 'citalopram',
                    'venlafaxine', 'duloxetine', 'bupropion', 'mirtazapine', 'trazodone', 'clonazepam',
                    'alprazolam'],
            
            GI: ['ondansetron', 'pantoprazole', 'famotidine', 'omeprazole', 'esomeprazole', 'lansoprazole',
                'ranitidine', 'docusate', 'senna', 'bisacodyl', 'polyethylene', 'metoclopramide',
                'promethazine', 'prochlorperazine'],
            
            CARDIO_PULM: ['metoprolol', 'carvedilol', 'atenolol', 'labetalol', 'esmolol', 'lisinopril', 
                         'enalapril', 'captopril', 'losartan', 'valsartan', 'amlodipine', 'diltiazem', 
                         'nicardipine', 'hydralazine', 'furosemide', 'bumetanide', 'torsemide', 
                         'spironolactone', 'albuterol', 'ipratropium', 'nitroglycerin', 'isosorbide',
                         'digoxin', 'amiodarone', 'sotalol', 'flecainide', 'rosuvastatin', 'atorvastatin',
                         'simvastatin', 'pravastatin', 'lovastatin', 'fluvastatin', 'pitavastatin'],
            
            ENDOCRINE: ['insulin', 'lispro', 'aspart', 'regular', 'isophane', 'nph', 'glargine', 'detemir',
                       'degludec', 'levothyroxine', 'liothyronine', 'hydrocortisone', 'dexamethasone']
        };

        let processedData = null;

        function processMedications() {
            const input = document.getElementById('medInput').value;
            const output = document.getElementById('output');
            
            if (!input.trim()) {
                alert('Please paste medication list first!');
                return;
            }
            
            processedData = parseMedications(input);
            displayBothTables(processedData);
            output.style.display = 'block';
        }

        function parseMedications(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const medications = {
                nutrition: [],
                pain: [],
                antibiotics: [],
                pressors: [],
                anticoag: [],
                neuro: [],
                gi: [],
                cardio: [],
                endocrine: [],
                misc: []
            };
            
            let currentCategory = null;
            let hypoglycemiaLines = [];
            
            const dietOrders = extractDietOrders(text);
            if (dietOrders.length > 0) {
                medications.nutrition.push(...dietOrders);
            }
            
            for (let line of lines) {
                if (line.includes('Medications (') || line.includes('Active')) {
                    continue;
                }
                
                if (line.includes('Scheduled:') || line.includes('Continuous:') || line.includes('PRN:')) {
                    currentCategory = line.toLowerCase().includes('prn') ? 'prn' : 'scheduled';
                    continue;
                }
                
                if (isHypoglycemiaProtocol(line)) {
                    hypoglycemiaLines.push(line);
                    continue;
                }
                
                if (line.trim() && !line.match(/^\(\d+\)$/)) {
                    const med = parseMedicationLine(line, currentCategory === 'prn');
                    if (med) {
                        categorizeMedication(med, medications);
                    }
                }
            }
            
            if (hypoglycemiaLines.length > 0) {
                medications.endocrine.push({
                    name: 'Hypoglycemia protocol',
                    fullName: 'Hypoglycemia protocol',
                    originalLine: hypoglycemiaLines.join('; '),
                    dose: '',
                    route: 'IV/PO',
                    frequency: '',
                    isPRN: true,
                    category: 'endocrine'
                });
            }
            
            return medications;
        }

        function extractDietOrders(text) {
            const dietOrders = [];
            const dietPatterns = [
                /NPO/i,
                /nothing by mouth/i,
                /clear liquid diet/i,
                /full liquid diet/i,
                /regular diet/i,
                /cardiac diet/i,
                /diabetic diet/i,
                /renal diet/i,
                /low sodium diet/i,
                /pureed diet/i,
                /mechanical soft diet/i,
                /dysphagia diet/i,
                /tube feed/i,
                /enteral nutrition/i
            ];
            
            for (let pattern of dietPatterns) {
                const match = text.match(pattern);
                if (match) {
                    let dietName = match[0];
                    if (dietName.toLowerCase() === 'npo') {
                        dietName = 'NPO';
                    } else {
                        dietName = dietName.split(' ').map(word => 
                            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                        ).join(' ');
                    }
                    
                    dietOrders.push({
                        name: dietName,
                        fullName: dietName,
                        originalLine: match[0],
                        dose: '',
                        route: 'PO',
                        frequency: '',
                        isPRN: false,
                        isDiet: true,
                        category: 'nutrition'
                    });
                }
            }
            
            return dietOrders;
        }

        function isHypoglycemiaProtocol(line) {
            const hypoIndicators = [
                'dextrose 10%',
                'dextrose 50%',
                'glucose 40%',
                'glucagon recombinant',
                'glucagon'
            ];
            return hypoIndicators.some(indicator => line.toLowerCase().includes(indicator));
        }

        function parseMedicationLine(line, isPRN) {
            const fluidResult = parseFluidInfusion(line, isPRN);
            if (fluidResult) return fluidResult;
            
            if (line.toLowerCase().includes('iv continuous')) {
                return parseInfusion(line, isPRN);
            }
            
            const insulinResult = parseInsulinSlidingScale(line, isPRN);
            if (insulinResult) return insulinResult;
            
            const doubleSeparator = line.indexOf('  ');
            if (doubleSeparator === -1) return null;
            
            const beforeSeparator = line.substring(0, doubleSeparator);
            const afterSeparator = line.substring(doubleSeparator + 2);
            
            const drugName = extractDrugName(beforeSeparator);
            const parts = afterSeparator.split(',').map(p => p.trim());
            
            let dose = parts[0] || '';
            let route = parts[1] || '';
            let frequency = parts[2] || '';
            
            // CRITICAL FIX: Extract combination drug doses from BEFORE separator
            dose = cleanDose(dose, beforeSeparator);
            route = abbreviateRoute(route);
            frequency = abbreviateFrequency(frequency);
            
            const abbreviated = abbreviateMedication(drugName);
            
            return {
                name: abbreviated,
                fullName: drugName,
                originalName: drugName,
                originalLine: line,
                dose: dose,
                route: route,
                frequency: frequency,
                isPRN: isPRN,
                original: line
            };
        }

        function parseFluidInfusion(line, isPRN) {
            const fluidPatterns = [
                { 
                    regex: /^sodium chloride\s+0\.9%.*?(\d+)\s*mL\/hr/i, 
                    name: 'NS',
                    check: line => line.toLowerCase().trim().startsWith('sodium chloride 0.9%')
                },
                { 
                    regex: /^sodium chloride\s+0\.45%.*?(\d+)\s*mL\/hr/i, 
                    name: '1/2NS',
                    check: line => line.toLowerCase().trim().startsWith('sodium chloride 0.45%')
                },
                { 
                    regex: /^lactated\s+ringer.*?(\d+)\s*mL\/hr/i, 
                    name: 'LR',
                    check: line => line.toLowerCase().trim().startsWith('lactated')
                },
                { 
                    regex: /^plasmalyte.*?(\d+)\s*mL\/hr/i, 
                    name: 'PL',
                    check: line => line.toLowerCase().trim().startsWith('plasmalyte')
                },
                { 
                    regex: /^parenteral nutrition.*?(\d+)\s*mL\/hr/i, 
                    name: 'TPN',
                    check: line => line.toLowerCase().trim().startsWith('parenteral nutrition')
                },
                { 
                    regex: /^dextrose\s+5%.*?(\d+)\s*mL\/hr/i, 
                    name: 'D5W',
                    check: line => line.toLowerCase().trim().startsWith('dextrose 5%')
                }
            ];
            
            for (let pattern of fluidPatterns) {
                if (pattern.check(line)) {
                    const match = line.match(pattern.regex);
                    if (match) {
                        const rate = match[1];
                        return {
                            name: `${pattern.name}@${rate}`,
                            fullName: `${pattern.name}@${rate}`,
                            originalName: pattern.name,
                            originalLine: line,
                            dose: '',
                            route: 'IV',
                            frequency: '',
                            isPRN: false,
                            isFluid: true,
                            category: 'nutrition'
                        };
                    }
                }
            }
            return null;
        }

        function parseInfusion(line, isPRN) {
            const infusionDrugs = [
                'norepinephrine', 'norEPINEPHrine', 'epinephrine', 'EPINEPHrine',
                'vasopressin', 'phenylephrine', 'dopamine', 'DOPamine', 'dobutamine',
                'heparin', 'insulin regular', 'propofol', 'fentanyl', 'fentaNYL',
                'midazolam', 'dexmedetomidine', 'dexmedeTOMIDine',
                'nitroglycerin', 'nicardipine', 'niCARdipine',
                'amiodarone', 'diltiazem', 'esmolol', 'ketamine'
            ];
            
            let drugName = '';
            const lineLower = line.toLowerCase();
            
            for (let drug of infusionDrugs) {
                if (lineLower.includes(drug.toLowerCase())) {
                    drugName = drug;
                    break;
                }
            }
            
            if (!drugName) {
                drugName = line.split(' ')[0];
            }
            
            const abbreviated = abbreviateMedication(drugName);
            const fullName = drugName.charAt(0).toUpperCase() + drugName.slice(1).toLowerCase();
            
            return {
                name: `${abbreviated} gtt`,
                fullName: line,
                originalName: drugName,
                originalLine: line,
                dose: '',
                route: 'IV',
                frequency: '',
                isPRN: false,
                isInfusion: true,
                original: line
            };
        }

        function parseInsulinSlidingScale(line, isPRN) {
            if (!line.toLowerCase().includes('insulin lispro') && !line.toLowerCase().includes('humalog')) {
                return null;
            }
            
            const match = line.match(/0-(\d+)\s*units?/i);
            if (match) {
                const maxUnits = parseInt(match[1]);
                const freqMatch = line.match(/every\s+(\d+)\s+hours/i);
                const freq = freqMatch ? `Q${freqMatch[1]}` : 'Q4';
                
                let scaleName = '';
                if (maxUnits >= 20) {
                    scaleName = 'ISS-R';
                } else if (maxUnits <= 10) {
                    scaleName = 'ISS-N';
                } else {
                    scaleName = 'ISS';
                }
                
                return {
                    name: `${scaleName} ${freq}`,
                    fullName: line,
                    originalName: 'Insulin sliding scale',
                    originalLine: line,
                    dose: '',
                    route: 'SC',
                    frequency: '',
                    isPRN: false,
                    category: 'endocrine'
                };
            }
            
            const scheduledMatch = line.match(/(\d+)\s*unit\(s\)/i);
            if (scheduledMatch && !line.includes('0-')) {
                const units = scheduledMatch[1];
                const freqMatch = line.match(/every\s+(\d+)\s+hours/i);
                const timesMatch = line.match(/(\d+)\s+times\s+a\s+day/i);
                
                let freq = '';
                if (freqMatch) {
                    freq = `Q${freqMatch[1]}`;
                } else if (timesMatch) {
                    const times = timesMatch[1];
                    if (times === '2') freq = 'BID';
                    else if (times === '3') freq = 'TID';
                    else if (times === '4') freq = 'QID';
                }
                
                return {
                    name: `Lispro${units}u ${freq}`,
                    fullName: line,
                    originalName: 'Insulin lispro',
                    originalLine: line,
                    dose: '',
                    route: 'SC',
                    frequency: '',
                    isPRN: false,
                    category: 'endocrine'
                };
            }
            
            return null;
        }

        function extractDrugName(text) {
            const formulationMarkers = /\d+\s*(mg|mcg|unit\(s\)|%|mL|g\b)/i;
            const match = text.match(formulationMarkers);
            
            let drugName;
            if (match) {
                drugName = text.substring(0, match.index).trim();
            } else {
                drugName = text.trim();
            }
            
            return drugName.replace(/\s*\([^)]*\)/g, '').trim();
        }

        // CRITICAL FIX: Handle combination drug doses properly
        function cleanDose(dose, beforeSeparator) {
            // Check for combination drug pattern in BEFORE separator
            // Example: sulfamethoxazole-trimethoprim 400 mg-80 mg Tab
            const comboDoseMatch = beforeSeparator ? beforeSeparator.match(/(\d+)\s*mg-(\d+)\s*mg/i) : null;
            if (comboDoseMatch) {
                // Return formatted dose like "400-80"
                return `${comboDoseMatch[1]}-${comboDoseMatch[2]}`;
            }
            
            // Regular single medication dose handling
            const match = dose.match(/^([\d,\.]+)\s*(mg|mcg|g|unit\(s\)|units?|mL|mEq|intl units)/i);
            if (match) {
                let value = match[1].replace(',', '');
                let unit = match[2];
                
                if (unit.toLowerCase() === 'mg' && parseFloat(value) >= 1000) {
                    value = parseFloat(value) / 1000;
                    unit = 'g';
                }
                
                unit = unit.replace('unit(s)', 'u').replace('units', 'u').replace('intl units', 'IU');
                
                return `${value}${unit}`;
            }
            
            return dose.split(/\s+/)[0];
        }

        function abbreviateRoute(route) {
            if (route.toLowerCase().includes('iv')) {
                return 'IV';
            }
            
            const routeMap = {
                'Oral': 'PO',
                'Subcutaneous': 'SC',
                'Intramuscular': 'IM',
                'Per Rectum': 'PR',
                'Transdermal': 'TD',
                'Inhalation': 'INH',
                'NEB': 'NEB',
                'Nasal': 'IN',
                'Eye-Both': 'OU',
                'Eye-Left': 'OS',
                'Eye-Right': 'OD',
                'Swish and Swallow': 'S&S'
            };
            
            return routeMap[route] || route;
        }

        function abbreviateFrequency(freq) {
            const hourMatch = freq.match(/every\s+(\d+)\s+hours?/i);
            if (hourMatch) {
                return `Q${hourMatch[1]}`;
            }
            
            const freqMap = {
                'Daily': 'QD',
                'Once': 'x1',
                '2 times a day': 'BID',
                '2 times per day': 'BID',
                '3 times a day': 'TID',
                '3 times per day': 'TID',
                '4 times a day': 'QID',
                '4 times per day': 'QID',
                '6 times per day': 'Q4',
                'every 7 days': 'Q7D',
                'every week': 'Q7D',
                'every 48 hours': 'Q48',
                'every evening': 'QPM',
                'every morning': 'QAM',
                'As Directed': 'PRN',
                'Monday and Thursday': 'Mon/Thu',
                'On Call': 'on call'
            };
            
            for (let [key, value] of Object.entries(freqMap)) {
                if (freq.includes(key)) {
                    return value;
                }
            }
            
            return freq;
        }

        function abbreviateMedication(drugName) {
            const nameLower = drugName.toLowerCase();
            
            for (let [key, abbrev] of Object.entries(MED_ABBREVIATIONS)) {
                if (nameLower.includes(key)) {
                    return abbrev;
                }
            }
            
            return drugName;
        }

        function categorizeMedication(med, medications) {
            const nameLower = (med.originalName || med.name).toLowerCase();
            
            if (med.isFluid || med.isDiet || nameLower.includes('parenteral nutrition')) {
                medications.nutrition.push(med);
                return;
            }
            
            for (let drug of CATEGORIES.PAIN) {
                if (nameLower.includes(drug)) {
                    medications.pain.push(med);
                    return;
                }
            }
            
            for (let drug of CATEGORIES.ANTIBIOTICS) {
                if (nameLower.includes(drug)) {
                    medications.antibiotics.push(med);
                    return;
                }
            }
            
            for (let drug of CATEGORIES.PRESSORS_SEDATION) {
                if (nameLower.includes(drug)) {
                    medications.pressors.push(med);
                    return;
                }
            }
            
            for (let drug of CATEGORIES.ANTICOAG) {
                if (nameLower.includes(drug)) {
                    medications.anticoag.push(med);
                    return;
                }
            }
            
            for (let drug of CATEGORIES.NEURO) {
                if (nameLower.includes(drug)) {
                    medications.neuro.push(med);
                    return;
                }
            }
            
            for (let drug of CATEGORIES.GI) {
                if (nameLower.includes(drug)) {
                    medications.gi.push(med);
                    return;
                }
            }
            
            for (let drug of CATEGORIES.CARDIO_PULM) {
                if (nameLower.includes(drug)) {
                    medications.cardio.push(med);
                    return;
                }
            }
            
            for (let drug of CATEGORIES.ENDOCRINE) {
                if (nameLower.includes(drug)) {
                    medications.endocrine.push(med);
                    return;
                }
            }
            
            medications.misc.push(med);
        }

        function formatMedication(med, useFullName = false) {
            if (useFullName) {
                return med.originalLine || med.fullName || med.name;
            }
            
            if (med.isFluid || med.isDiet) {
                return med.name;
            }
            
            if (med.isInfusion) {
                return med.name;
            }
            
            let result = med.name;
            
            if (med.dose) {
                result += med.dose;
            }
            
            if (med.frequency) {
                result += ` ${med.frequency}`;
            }
            
            if (med.route) {
                result += ` ${med.route}`;
            }
            
            if (med.isPRN) {
                result += ' PRN';
            }
            
            return result;
        }

        function displayBothTables(meds) {
            displayTable(meds, 'abbreviatedView', false);
            displayTable(meds, 'fullView', true);
            updateStats(meds);
        }

        function displayTable(meds, containerId, useFullName) {
            const container = document.getElementById(containerId);
            
            let html = `<h2>${useFullName ? 'üìã Full Medication List' : '‚ö° Abbreviated View'}</h2>`;
            html += '<table>';
            html += '<thead><tr><th>Category</th><th>PO Route</th><th>IV Route</th></tr></thead>';
            html += '<tbody>';
            
            html += addCategoryRow('Nutrition/Fluids', meds.nutrition, useFullName);
            html += addCategoryRow('Pain', meds.pain, useFullName);
            html += addCategoryRow('Antibiotics', meds.antibiotics, useFullName);
            html += addCategoryRow('Pressors/Sedation', meds.pressors, useFullName);
            html += addCategoryRow('Anticoagulation', meds.anticoag, useFullName);
            html += addCategoryRow('Neuro/Psych', meds.neuro, useFullName);
            html += addCategoryRow('GI', meds.gi, useFullName);
            html += addCategoryRow('Cardio/Pulm', meds.cardio, useFullName);
            html += addCategoryRow('Endocrine', meds.endocrine, useFullName);
            html += addCategoryRow('MISC', meds.misc, useFullName);
            
            html += '</tbody></table>';
            
            container.innerHTML = html;
        }

        function addCategoryRow(categoryName, medList, useFullName) {
            const poMeds = medList.filter(m => 
                m.route === 'PO' || m.route === 'SC' || m.route === 'PR' || 
                m.route === 'INH' || m.route === 'NEB' || m.route === 'TD' ||
                m.route === 'OU' || m.route === 'IN' || m.route === 'S&S' ||
                m.route === 'IM' || m.isDiet
            );
            const ivMeds = medList.filter(m => m.route === 'IV' || m.route === 'IV/PO');
            
            let html = '<tr>';
            html += `<td class="category-header">${categoryName}</td>`;
            
            html += '<td>';
            if (poMeds.length > 0) {
                poMeds.forEach(med => {
                    const formatted = formatMedication(med, useFullName);
                    const className = med.isPRN ? 'prn' : '';
                    html += `<div class="${className}">${formatted}</div>`;
                });
            } else {
                html += '<span class="empty-cell">‚Äî</span>';
            }
            html += '</td>';
            
            html += '<td>';
            if (ivMeds.length > 0) {
                ivMeds.forEach(med => {
                    const formatted = formatMedication(med, useFullName);
                    const className = med.isPRN ? 'prn' : (med.isInfusion || med.isFluid ? 'infusion' : '');
                    html += `<div class="${className}">${formatted}</div>`;
                });
            } else {
                html += '<span class="empty-cell">‚Äî</span>';
            }
            html += '</td>';
            
            html += '</tr>';
            return html;
        }

        function updateStats(meds) {
            const totalMeds = Object.values(meds).reduce((sum, arr) => sum + arr.length, 0);
            const prnCount = Object.values(meds).reduce((sum, arr) => 
                sum + arr.filter(m => m.isPRN).length, 0);
            const infusionCount = Object.values(meds).reduce((sum, arr) => 
                sum + arr.filter(m => m.isInfusion || m.isFluid).length, 0);
            
            document.getElementById('stats').innerHTML = `
                <div class="stat-item"><strong>Total Medications:</strong> ${totalMeds}</div>
                <div class="stat-item"><strong>PRN Medications:</strong> ${prnCount}</div>
                <div class="stat-item"><strong>Infusions:</strong> ${infusionCount}</div>
            `;
        }

        function switchView(view) {
            const abbrevView = document.getElementById('abbreviatedView');
            const fullView = document.getElementById('fullView');
            const buttons = document.querySelectorAll('.table-toggle button');
            
            if (view === 'abbreviated') {
                abbrevView.style.display = 'block';
                fullView.style.display = 'none';
                buttons[0].classList.add('active');
                buttons[1].classList.remove('active');
            } else {
                abbrevView.style.display = 'none';
                fullView.style.display = 'block';
                buttons[0].classList.remove('active');
                buttons[1].classList.add('active');
            }
        }

        function copyTable(view) {
            const table = view === 'abbreviated' 
                ? document.querySelector('#abbreviatedView table')
                : document.querySelector('#fullView table');
            
            if (!table) {
                alert('No table to copy!');
                return;
            }
            
            let text = '';
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td, th');
                const rowText = Array.from(cells).map(cell => cell.innerText).join('\t');
                text += rowText + '\n';
            });
            
            navigator.clipboard.writeText(text).then(() => {
                alert(`${view === 'abbreviated' ? 'Abbreviated' : 'Full'} table copied to clipboard!`);
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function toggleAdmin() {
            const admin = document.getElementById('adminSection');
            admin.style.display = admin.style.display === 'none' ? 'block' : 'none';
            updateMedCount();
        }

        function updateMedCount() {
            document.getElementById('medCount').textContent = Object.keys(MED_ABBREVIATIONS).length;
        }

        function showDatabase() {
            const db = document.getElementById('medDatabase');
            const isVisible = db.style.display !== 'none';
            
            if (!isVisible) {
                let html = '';
                const sortedMeds = Object.entries(MED_ABBREVIATIONS).sort((a, b) => a[0].localeCompare(b[0]));
                sortedMeds.forEach(([full, abbrev]) => {
                    html += `<div>${full} ‚Üí ${abbrev}</div>`;
                });
                db.innerHTML = html;
                db.style.display = 'block';
            } else {
                db.style.display = 'none';
            }
        }

        function addMedToCategory(category, nameInputId, abbrevInputId) {
            const name = document.getElementById(nameInputId).value.trim().toLowerCase();
            const abbrev = document.getElementById(abbrevInputId).value.trim();
            
            if (!name || !abbrev) {
                alert('Please enter both medication name and abbreviation!');
                return;
            }
            
            MED_ABBREVIATIONS[name] = abbrev;
            
            if (CATEGORIES[category]) {
                if (!CATEGORIES[category].includes(name)) {
                    CATEGORIES[category].push(name);
                }
            }
            
            document.getElementById(nameInputId).value = '';
            document.getElementById(abbrevInputId).value = '';
            
            updateMedCount();
            alert(`‚úì Added to ${category}: ${name} ‚Üí ${abbrev}`);
        }

        updateMedCount();
    </script>
</body>
</html>
